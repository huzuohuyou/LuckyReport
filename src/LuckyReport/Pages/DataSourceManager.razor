@page "/datasourcs"
@using System.Text.Json
@using LuckyReport.Shared

<Modal Title="@("BasicModal")"
       Visible="@_visible"
       OnOk="@HandleOk"
       OnCancel="@HandleCancel">
    <Form Loading="_loading" Model="@_model"
          LabelColSpan="8"
          WrapperColSpan="16"
          OnFinish="OnFinish"
          OnFinishFailed="OnFinishFailed"
          @ref="@_form">
        <FormItem Label="Name">
            <Input @bind-Value="@context.Name" />
        </FormItem>
        <FormItem Label="Uri">
            <Input @bind-Value="@context.Uri" />
        </FormItem>
    </Form>
</Modal>

<Card>
    <Button Type="@ButtonType.Primary" OnClick="@ShowModal">
        新建
    </Button>
</Card>
<Card Style="height: 700px">
    <Table @ref="_table"
           TItem="DataSource"
           DataSource="@_dataSources"
           Total="_total"
           @bind-PageIndex="_pageIndex"
           @bind-PageSize="_pageSize"
           @bind-SelectedRows="_selectedRows"
    >
        <PropertyColumn Width="100" Property="c=>c.Id" Sortable />
        <PropertyColumn Width="200" Property="c=>c.Name" Sortable />
        <PropertyColumn  Property="c=>c.Uri" Sortable />
        <ActionColumn Width="240" Title="Action">
            <Space>
                <SpaceItem><Button  Type="@ButtonType.Primary" OnClick="()=>Edit(context.Id)">Edit</Button></SpaceItem>
                <SpaceItem><Button Danger OnClick="() => Delete(context.Id)">Delete</Button></SpaceItem>
            </Space>
        </ActionColumn>
    </Table>
</Card>



@code {

    IEnumerable<DataSource> _dataSources;
    IEnumerable<DataSource> _selectedRows;
    ITable _table;

    int _pageIndex = 1;
    int _pageSize = 10;
    int _total;

    protected override async Task OnInitializedAsync()
    {
        _dataSources = await new swaggerClient("https://localhost:7103/", new HttpClient()).DataSourcesAllAsync();
        _total = _dataSources.Count();
    }
    
    private void Edit(int id)
    {
        //Navigation.NavigateTo($@"reports/{id}");
    }

    private async Task Delete(int id)
    {
        await new swaggerClient("https://localhost:7103/", new HttpClient()).DataSources4Async(id);
        _dataSources = await new swaggerClient("https://localhost:7103/", new HttpClient()).DataSourcesAllAsync();
        _total = _dataSources.Count();
    }

    #region original form coding

    private readonly DataSource _model = new ();

    private  void OnFinishFailed(EditContext editContext)
    {
        Toggle(false);
        //dataSources = await new swaggerClient("https://localhost:7103/", new HttpClient()).DataSourcesAllAsync();
        //_total = dataSources.Count();
        //_visible = false;
        Console.WriteLine($"Failed:{JsonSerializer.Serialize(_model)}");
    }

    bool _loading;

    void Toggle(bool value) => _loading = value;

    #endregion

    #region original modal coding

    bool _visible;

    private void ShowModal()
    {
        _visible = true;
    }

    private void HandleCancel(MouseEventArgs e)
    {
        Toggle(false);
        Console.WriteLine("e");
        _visible = false;
    }

    #endregion

    /*
     * Careful!
     *
     * next bind submit event to modal OK button
     */

    private Form<DataSource> _form;

    /// <summary>
    /// when form is submited, close the modal
    /// </summary>
    private async Task OnFinish(EditContext editContext)
    {
        Toggle(false);
        _dataSources = await new swaggerClient("https://localhost:7103/", new HttpClient()).DataSourcesAllAsync();
        _total = _dataSources.Count();
        _visible = false;
    }

    /// <summary>
    /// on modal OK button is click, submit form manually
    /// </summary>
    /// <param name="e"></param>
    private async Task HandleOk(MouseEventArgs e)
    {
        Toggle(true);
        await new swaggerClient("https://localhost:7103/", new HttpClient()).DataSourcesAsync(_model);
        _form.Submit();
    }
}